<head>
<meta charset="utf-8">
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<style type="text/css">
div.tooltip {   
 	position: absolute;           
	text-align: center;           
	width: 60px;                  
	height: 18px;                 
	padding: 2px;             
	font: 13px sans-serif;        
	background: white;   
	border: 0px;      
	border-radius: 8px;           
	pointer-events: none;         
}
</style>
</head>
<body>
<script>

var w = 500;
var h = 300;

var svg = d3.select("body")
      .append("svg")
      .attr("width", w)
      .attr("height", h);

svg.append("text")
	.attr("x", 20)
	.attr("y", 30)
	.text("Market Location")
	.style("font-size", 15);

var svg2 = d3.select("body")
      .append("svg")
      .attr("width", w)
      .attr("height", h);
//axis for svg2
var startDate = new Date(2012, 8);
var endDate = new Date(2016, 9);

var x = d3.time.scale()
				.domain([startDate,endDate])
    			.range([0, w]);
var xAxis = d3.svg.axis()
    .scale(x)
    .tickSize(0)
    .ticks(10);

svg2.append("g")
	.attr("class", "x axis")
	.style("font-size", "10px")
	.attr("transform", "translate(0," + (h-50) + ")")
	.call(xAxis)
	.selectAll("text")
    .attr("transform", "rotate(-90)")
    .style("text-anchor", "start");

svg2.append("text")
		.attr("x", 0)
		.attr("y", 30)
		.style("font-size", 15)
		.text("Price Trend")

// Append Div for tooltip to SVG
var div = d3.select("body")
		    .append("div")   
    		.attr("class", "tooltip")               
    		.style("opacity", 0);

//USA Map
var projection = d3.geo.albersUsa()
                        .translate([w/2, h/2])
                        .scale([500]);

var path = d3.geo.path().projection(projection);

//Stream Graph
var x = d3.scale.linear()
    .domain([0, 35])
    .range([0, w]);

var area = d3.svg.area()
    .interpolate("basis")
    .x(function(d, i) { return x(i); })
    .y0(function(d) { return -d*10; })
    .y1(function(d) { return d*10; });

queue()
	.defer(d3.json, 'states.json')
	.defer(d3.csv, 'cities.CSV')
	.defer(d3.csv, 'dataset.CSV')
	.await(makeMyMap);

function makeMyMap(error, states, cities, dataset) {
	svg.selectAll("pathUS")
        .data(states.features)
        .enter()
        .append("path")
        .style("stroke-width", 1)
        .style("stroke", "white")
        .attr("d", path)
        .style("fill", "#67a9cf")
        .style("opacity", 0.75);

    svg.selectAll("circleCity")
		   .data(cities)
		   .enter()
		   .append("circle")
		   .attr("cx", function(d) {
			   return projection([d.W, d.N])[0];
		   })
		   .attr("cy", function(d) {
			   return projection([d.W, d.N])[1];
		   })
		   .attr("id", function(d){return d.City;})
		   .attr("r", 5)
		   .style("fill", "#ef8a62")
		   .style("opacity", 0.75)
		   .on("mouseover", function(d) {      
		    	div.transition()        
		      	   .duration(500)      
		           .style("opacity", .9);

		        div.text(d.City)
		           .style("left", (d3.event.pageX) + "px")     
		           .style("top", (d3.event.pageY - 25) + "px");   
		        
		        d3.select(this).transition().duration(500)
		      	   .attr("r", 8).style("opacity", 1); 
		      	
		      	selectCity(d.City);
			})                
		   .on("mouseout", function(d) {       
		       div.transition()        
		          .duration(500)      
		          .style("opacity", 0);  
		       
		       d3.select(this).transition().duration(500)
		          .attr("r", 5).style("opacity", 0.75); 
		    });
    
    monthKey = d3.keys(dataset[0]);
    monthKey.pop();//remove the last element
    monthKey.pop();//remove the last element
    monthKey.shift();//remove the first element

    function selectCity(city)
    {
    	var data = dataset.filter(function(d){
    		if (d["Market"] == city)
    			return d;
    	});
    	
    	var timeLineValue = new Array();

    	svg2.selectAll("path").transition().duration(200).remove();
    	svg2.selectAll("line").remove();
    	
    	if(data.length){
	    	for(var i = 0; i < data.length; i ++){
	    		for(var j = 0; j < monthKey.length; j ++)
	    		{
	    			var rowdata = data[i];
	    			timeLineValue.push(Number(rowdata[monthKey[j]]));
	    		}
	    	}

	   		svg2.selectAll("pathStream")
			    .data([timeLineValue])
			  .enter().append("path")
			    .attr("transform", function(d, i) { return "translate(0," + h/2 + ")"; })
			    .style("fill", "#8dd3c7")
			    .style("opacity", 0)
			    .attr("d", area)
			    .on("mouseover", function(d){
			    	svg.select("#"+city).transition().duration(500).attr("r", 8).style("opacity", 0.75);
			    	var divposX = svg.select("#"+city).attr("cx");
			    	var divposY = svg.select("#"+city).attr("cy");
			    	div.transition()        
			      	   .duration(500)      
			           .style("opacity", .9);

			        div.text(city)
			           .style("left",(divposX + 10)+ "px")     
			           .style("top", (divposY - 25) + "px"); 
			    })
			    .on("mouseout", function(d){
			    	svg.select("#"+city).transition().duration(500).attr("r", 5).style("opacity", 0.75);
			    	div.transition()        
				        .duration(500)      
				        .style("opacity", 0);  
			    })
			    .transition().duration(200)
			    .style("opacity", 0.75);

			for(var i = 0; i < 36; i ++)
			{
				svg2.append("line")
					.attr("x1",i*w/36)
					.attr("y1",30)
					.attr("x2",i*w/36)
					.attr("y2",h-80)
					.style("stroke", "white")
					.style("stroke-width", 1)
			}
	   }

    }
}

</script>
</body>
